package post

import (
	"encoding/json"
	"testing"

	"github.com/esonhugh/k8spider/define"
	"github.com/esonhugh/k8spider/pkg/scanner"
)

func TestRecordsDump(t *testing.T) {
	rs, err := scanner.DumpAXFR("zonetransfer.me.", "81.4.108.41:53")
	if err != nil {
		t.Errorf("DumpAXFR failed: %v", err)
	}
	jsondata, _ := json.Marshal(rs)
	t.Log(string(jsondata))
	rs2, err := scanner.DumpAXFR("megacorpone.com", "51.79.37.18:53")
	jsondata, _ = json.Marshal(rs2)
	t.Log(string(jsondata))
}

const Sample = `{"Ip":"","SvcDomain":"","SrvRecords":[{"Cname":"any.any.svc.cluster.local.","Srv":[{"Target":"kube-dns.kube-system.svc.cluster.local.","Port":9153,"Priority":0,"Weight":25},{"Target":"kubernetes.default.svc.cluster.local.","Port":443,"Priority":0,"Weight":25},{"Target":"kube-dns.kube-system.svc.cluster.local.","Port":53,"Priority":0,"Weight":25}]}]}`
const Sample2 = `{"Ip":"","SvcDomain":"","SrvRecords":[{"Cname":"any.any.any.svc.cluster.local.","Srv":[{"Target":"172-18-0-2.kubernetes.default.svc.cluster.local.","Port":6443,"Priority":0,"Weight":14},{"Target":"10-244-0-4.kube-dns.kube-system.svc.cluster.local.","Port":9153,"Priority":0,"Weight":14},{"Target":"10-244-0-4.kube-dns.kube-system.svc.cluster.local.","Port":53,"Priority":0,"Weight":14},{"Target":"10-244-0-2.kube-dns.kube-system.svc.cluster.local.","Port":53,"Priority":0,"Weight":14},{"Target":"10-244-0-2.kube-dns.kube-system.svc.cluster.local.","Port":9153,"Priority":0,"Weight":14}]}]}`
const AxfrSample = `[{"Ip":"","SvcDomain":"zonetransfer.me.","SrvRecords":null,"Extra":"zonetransfer.me. 7200 IN SOA nsztm1.digi.ninja. robin.digi.ninja. 2019100801 172800 900 1209600 3600"},{"Ip":"","SvcDomain":"zonetransfer.me.","SrvRecords":null,"Extra":"zonetransfer.me. 300 IN HINFO \"Casio fx-700G\" \"Windows XP\""},{"Ip":"","SvcDomain":"zonetransfer.me.","SrvRecords":null,"Extra":"zonetransfer.me. 301 IN TXT \"google-site-verification=tyP28J7JAUHA9fw2sHXMgcCC0I6XBmmoVi04VlMewxA\""},{"Ip":"","SvcDomain":"zonetransfer.me.","SrvRecords":null,"Extra":"zonetransfer.me. 7200 IN MX 0 ASPMX.L.GOOGLE.COM."},{"Ip":"","SvcDomain":"zonetransfer.me.","SrvRecords":null,"Extra":"zonetransfer.me. 7200 IN MX 10 ALT1.ASPMX.L.GOOGLE.COM."},{"Ip":"","SvcDomain":"zonetransfer.me.","SrvRecords":null,"Extra":"zonetransfer.me. 7200 IN MX 10 ALT2.ASPMX.L.GOOGLE.COM."},{"Ip":"","SvcDomain":"zonetransfer.me.","SrvRecords":null,"Extra":"zonetransfer.me. 7200 IN MX 20 ASPMX2.GOOGLEMAIL.COM."},{"Ip":"","SvcDomain":"zonetransfer.me.","SrvRecords":null,"Extra":"zonetransfer.me. 7200 IN MX 20 ASPMX3.GOOGLEMAIL.COM."},{"Ip":"","SvcDomain":"zonetransfer.me.","SrvRecords":null,"Extra":"zonetransfer.me. 7200 IN MX 20 ASPMX4.GOOGLEMAIL.COM."},{"Ip":"","SvcDomain":"zonetransfer.me.","SrvRecords":null,"Extra":"zonetransfer.me. 7200 IN MX 20 ASPMX5.GOOGLEMAIL.COM."},{"Ip":"","SvcDomain":"zonetransfer.me.","SrvRecords":null,"Extra":"zonetransfer.me. 7200 IN A 5.196.105.14"},{"Ip":"","SvcDomain":"zonetransfer.me.","SrvRecords":null,"Extra":"zonetransfer.me. 7200 IN NS nsztm1.digi.ninja."},{"Ip":"","SvcDomain":"zonetransfer.me.","SrvRecords":null,"Extra":"zonetransfer.me. 7200 IN NS nsztm2.digi.ninja."},{"Ip":"","SvcDomain":"_acme-challenge.zonetransfer.me.","SrvRecords":null,"Extra":"_acme-challenge.zonetransfer.me. 301 IN TXT \"6Oa05hbUJ9xSsvYy7pApQvwCUSSGgxvrbdizjePEsZI\""},{"Ip":"","SvcDomain":"_sip._tcp.zonetransfer.me.","SrvRecords":null,"Extra":"_sip._tcp.zonetransfer.me. 14000 IN SRV 0 0 5060 www.zonetransfer.me."},{"Ip":"","SvcDomain":"14.105.196.5.IN-ADDR.ARPA.zonetransfer.me.","SrvRecords":null,"Extra":"14.105.196.5.IN-ADDR.ARPA.zonetransfer.me. 7200 IN PTR www.zonetransfer.me."},{"Ip":"","SvcDomain":"asfdbauthdns.zonetransfer.me.","SrvRecords":null,"Extra":"asfdbauthdns.zonetransfer.me. 7900 IN AFSDB 1 asfdbbox.zonetransfer.me."},{"Ip":"","SvcDomain":"asfdbbox.zonetransfer.me.","SrvRecords":null,"Extra":"asfdbbox.zonetransfer.me. 7200 IN A 127.0.0.1"},{"Ip":"","SvcDomain":"asfdbvolume.zonetransfer.me.","SrvRecords":null,"Extra":"asfdbvolume.zonetransfer.me. 7800 IN AFSDB 1 asfdbbox.zonetransfer.me."},{"Ip":"","SvcDomain":"canberra-office.zonetransfer.me.","SrvRecords":null,"Extra":"canberra-office.zonetransfer.me. 7200 IN A 202.14.81.230"},{"Ip":"","SvcDomain":"cmdexec.zonetransfer.me.","SrvRecords":null,"Extra":"cmdexec.zonetransfer.me. 300 IN TXT \"; ls\""},{"Ip":"","SvcDomain":"contact.zonetransfer.me.","SrvRecords":null,"Extra":"contact.zonetransfer.me. 2592000 IN TXT \"Remember to call or email Pippa on +44 123 4567890 or pippa@zonetransfer.me when making DNS changes\""},{"Ip":"","SvcDomain":"dc-office.zonetransfer.me.","SrvRecords":null,"Extra":"dc-office.zonetransfer.me. 7200 IN A 143.228.181.132"},{"Ip":"","SvcDomain":"deadbeef.zonetransfer.me.","SrvRecords":null,"Extra":"deadbeef.zonetransfer.me. 7201 IN AAAA dead:beaf::"},{"Ip":"","SvcDomain":"dr.zonetransfer.me.","SrvRecords":null,"Extra":"dr.zonetransfer.me. 300 IN LOC 53 20 56.558 N 01 38 33.526 W 0m 1m 10000m 10m"},{"Ip":"","SvcDomain":"DZC.zonetransfer.me.","SrvRecords":null,"Extra":"DZC.zonetransfer.me. 7200 IN TXT \"AbCdEfG\""},{"Ip":"","SvcDomain":"email.zonetransfer.me.","SrvRecords":null,"Extra":"email.zonetransfer.me. 2222 IN NAPTR 1 1 \"P\" \"E2U+email\" \"\" email.zonetransfer.me.zonetransfer.me."},{"Ip":"","SvcDomain":"email.zonetransfer.me.","SrvRecords":null,"Extra":"email.zonetransfer.me. 7200 IN A 74.125.206.26"},{"Ip":"","SvcDomain":"Hello.zonetransfer.me.","SrvRecords":null,"Extra":"Hello.zonetransfer.me. 7200 IN TXT \"Hi to Josh and all his class\""},{"Ip":"","SvcDomain":"home.zonetransfer.me.","SrvRecords":null,"Extra":"home.zonetransfer.me. 7200 IN A 127.0.0.1"},{"Ip":"","SvcDomain":"Info.zonetransfer.me.","SrvRecords":null,"Extra":"Info.zonetransfer.me. 7200 IN TXT \"ZoneTransfer.me service provided by Robin Wood - robin@digi.ninja. See http://digi.ninja/projects/zonetransferme.php for more information.\""},{"Ip":"","SvcDomain":"internal.zonetransfer.me.","SrvRecords":null,"Extra":"internal.zonetransfer.me. 300 IN NS intns1.zonetransfer.me."},{"Ip":"","SvcDomain":"internal.zonetransfer.me.","SrvRecords":null,"Extra":"internal.zonetransfer.me. 300 IN NS intns2.zonetransfer.me."},{"Ip":"","SvcDomain":"intns1.zonetransfer.me.","SrvRecords":null,"Extra":"intns1.zonetransfer.me. 300 IN A 81.4.108.41"},{"Ip":"","SvcDomain":"intns2.zonetransfer.me.","SrvRecords":null,"Extra":"intns2.zonetransfer.me. 300 IN A 167.88.42.94"},{"Ip":"","SvcDomain":"office.zonetransfer.me.","SrvRecords":null,"Extra":"office.zonetransfer.me. 7200 IN A 4.23.39.254"},{"Ip":"","SvcDomain":"ipv6actnow.org.zonetransfer.me.","SrvRecords":null,"Extra":"ipv6actnow.org.zonetransfer.me. 7200 IN AAAA 2001:67c:2e8:11::c100:1332"},{"Ip":"","SvcDomain":"owa.zonetransfer.me.","SrvRecords":null,"Extra":"owa.zonetransfer.me. 7200 IN A 207.46.197.32"},{"Ip":"","SvcDomain":"robinwood.zonetransfer.me.","SrvRecords":null,"Extra":"robinwood.zonetransfer.me. 302 IN TXT \"Robin Wood\""},{"Ip":"","SvcDomain":"rp.zonetransfer.me.","SrvRecords":null,"Extra":"rp.zonetransfer.me. 321 IN RP robin.zonetransfer.me. robinwood.zonetransfer.me."},{"Ip":"","SvcDomain":"sip.zonetransfer.me.","SrvRecords":null,"Extra":"sip.zonetransfer.me. 3333 IN NAPTR 2 3 \"P\" \"E2U+sip\" \"!^.*$!sip:customer-service@zonetransfer.me!\" ."},{"Ip":"","SvcDomain":"sqli.zonetransfer.me.","SrvRecords":null,"Extra":"sqli.zonetransfer.me. 300 IN TXT \"' or 1=1 --\""},{"Ip":"","SvcDomain":"sshock.zonetransfer.me.","SrvRecords":null,"Extra":"sshock.zonetransfer.me. 7200 IN TXT \"() { :]}; echo ShellShocked\""},{"Ip":"","SvcDomain":"staging.zonetransfer.me.","SrvRecords":null,"Extra":"staging.zonetransfer.me. 7200 IN CNAME www.sydneyoperahouse.com."},{"Ip":"","SvcDomain":"alltcpportsopen.firewall.test.zonetransfer.me.","SrvRecords":null,"Extra":"alltcpportsopen.firewall.test.zonetransfer.me. 301 IN A 127.0.0.1"},{"Ip":"","SvcDomain":"testing.zonetransfer.me.","SrvRecords":null,"Extra":"testing.zonetransfer.me. 301 IN CNAME www.zonetransfer.me."},{"Ip":"","SvcDomain":"vpn.zonetransfer.me.","SrvRecords":null,"Extra":"vpn.zonetransfer.me. 4000 IN A 174.36.59.154"},{"Ip":"","SvcDomain":"www.zonetransfer.me.","SrvRecords":null,"Extra":"www.zonetransfer.me. 7200 IN A 5.196.105.14"},{"Ip":"","SvcDomain":"xss.zonetransfer.me.","SrvRecords":null,"Extra":"xss.zonetransfer.me. 300 IN TXT \"'\u003e\u003cscript\u003ealert('Boo')\u003c/script\u003e\""},{"Ip":"","SvcDomain":"zonetransfer.me.","SrvRecords":null,"Extra":"zonetransfer.me. 7200 IN SOA nsztm1.digi.ninja. robin.digi.ninja. 2019100801 172800 900 1209600 3600"}]`

func TestRecordsDump2(t *testing.T) {
	t.Log(GetNamespaceFromDomain("1111.222.any.namespace.svc.cluster.local.", "cluster.local"))

	r1 := &define.Record{}
	json.Unmarshal([]byte(Sample), r1)
	r2 := &define.Record{}
	json.Unmarshal([]byte(Sample2), r2)
	r3 := []define.Record{}
	json.Unmarshal([]byte(AxfrSample), &r3)
	rs := []define.Record{*r1, *r2}
	t.Log(RecordsDumpNameSpace(rs, "cluster.local"))
	t.Log(RecordsDumpNameSpace(r3, "zonetransfer.me."))
	t.Log(RecordsDumpFullService(rs, "cluster.local"))
	t.Log(RecordsDumpFullService(r3, "zonetransfer.me."))
}
